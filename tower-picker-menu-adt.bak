(load "tower-picker-item-adt.rkt")

(define (make-tower-picker-menu selected-index)
  (let ((tower-picker-menu-items (make-vector (length tower-configurations))))

    ; Procedure that makes a tower picker menu in the sidebar
    (define (make-tower-picker-menu)
      (define (loop tower-configs i)
        (when (not (null? tower-configs))
          (vector-set! tower-picker-menu-items i
                       (make-tower-picker-item (tower-config-name (car tower-configs))
                                               (tower-config-image (car tower-configs))
                                               (make-position horizontal-cells-amount (* i tower-item-height))))
          (loop (cdr tower-configs) (+ i 1))))
      (loop tower-configurations 0))

    (define (get-tower-item-from-position position)
      (define (hulp index)
        (if (< index (vector-length tower-picker-menu-items))
            (let* ((item (vector-ref tower-picker-menu-items index))
                   (item-position (item 'get-position)))
              (if (and (>= (position 'get-x) (item-position 'get-x))
                       (>= (position 'get-y) (item-position 'get-y))
                       (< (position 'get-x) (+ (item-position 'get-x) 1))
                       (< (position 'get-y) (+ (item-position 'get-y) tower-item-height)))
                  item
                  (hulp (+ index 1))))
            #f))
      (hulp 0))
              
    
    (define (dispatch msg)
      (cond ((eq? msg 'get-picker-items) tower-picker-menu-items)
            ((eq? msg 'get-tower-item-from-position) get-tower-item-from-position)
            (else (display ("ERROR -- tower-adt dispatch message not understood: ")) (display msg))))
    (make-tower-picker-menu)
    dispatch))